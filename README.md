# Xray 脚本语言

一门轻量化、高性能、兼容性好的脚本语言，使用 ANSI C 开发。

## 项目简介

Xray 是一门参考 Lua、Wren、QuickJS 设计的脚本语言，语法类似 TypeScript。项目目标：

- **代码规模**：< 10,000 行
- **性能目标**：介于 Wren 和 Lua 之间
- **可维护性**：优先于极致性能
- **易学习**：代码清晰，注释丰富

## 当前状态

**版本**：v0.3.0  
**开发阶段**：第三阶段完成（变量与作用域）

### 已完成功能
- ✅ 完整的词法分析器（v0.1.0）
- ✅ 表达式求值器（v0.2.0）
  - 算术运算：`+`, `-`, `*`, `/`, `%`
  - 比较运算：`==`, `!=`, `<`, `<=`, `>`, `>=`
  - 逻辑运算：`&&`, `||`, `!`
  - 短路求值
- ✅ 变量与作用域（v0.3.0）
  - `let` 变量声明
  - `const` 常量声明
  - 变量赋值
  - 块级作用域
  - 变量遮蔽
  - REPL 变量持久化

### 测试状态
- **C 语言测试**：123/123 通过 ✅
  - 词法分析器：53 个测试
  - AST 模块：10 个测试
  - 语法解析器：19 个测试
  - 表达式求值器：18 个测试
  - 变量系统：22 个测试
  - For 循环：1 个测试
- **示例程序**：6/6 通过 ✅
- **编译状态**：无错误 ✅

## 快速开始

### 编译

```bash
cd xray
make
```

### 运行

```bash
# 显示版本
./xray -v

# 显示帮助
./xray -h

# 运行 REPL（交互式环境）
./xray

# 执行脚本文件
./xray example/07_variables.xr

# 执行代码字符串
./xray -e "let x = 10"

# 查看 AST 结构（调试）
./xray --dump-ast example/07_variables.xr
```

### 运行测试

```bash
make test
```

### 清理

```bash
make clean
```

## 语法示例

**重要**：Xray **不使用**分号作为语句结束符，语句通过换行自动结束。分号**仅用于** for 循环中的条件分割。

### 变量和常量
```javascript
// 变量声明
let x = 10
let name = "Xray"

// 变量赋值
x = 20

// 常量声明（不可修改）
const PI = 3.14

// 表达式
let sum = x + 10
print(sum)
```

### 作用域
```javascript
let x = "global"
{
    let x = "local"  // 遮蔽外层
    print(x)         // local
}
print(x)             // global
```

### 表达式
```javascript
// 算术运算
print(1 + 2 * 3)     // 7

// 比较运算
print(5 > 3)         // true

// 逻辑运算
print(true && false) // false
```

### 控制流（计划中）
```javascript
// if-else（第四阶段）
if (x > 5) {
    print("large")
} else {
    print("small")
}

// while 循环（第四阶段）
while (i < 10) {
    print(i)
    i = i + 1
}

// for 循环（第四阶段）
// 注意：分号用作条件分隔符
for (let i = 0; i < 10; i = i + 1) {
//              ^分隔  ^分隔
    print(i)
}
```

### 数据类型
- `null` - 空值
- `int` - 整数
- `float` - 浮点数
- `string` - 字符串
- `array` - 数组（计划中）
- `set` - 集合（计划中）
- `map` - 映射（计划中）
- `class` - 类（计划中）

## 项目结构

```
xray/
├── xray.h              # 主头文件
├── xvalue.h/c          # 值类型系统
├── xstate.h/c          # 状态管理
├── xlex.h/c            # 词法分析器
├── xast.h/c            # 抽象语法树
├── xparse.h/c          # 语法解析器（Pratt）
├── xeval.h/c           # 表达式求值器
├── xscope.h/c          # 符号表和作用域
├── main.c              # 主程序
├── Makefile            # 构建文件
├── example/            # 示例程序
│   ├── 04_expressions.xr
│   ├── 05_comparisons.xr
│   ├── 06_logic.xr
│   ├── 07_variables.xr
│   ├── 08_scope.xr
│   └── 09_constants.xr
└── test/               # 测试程序
    ├── test_lexer.c
    ├── test_for_loop.c
    ├── test_ast.c
    ├── test_parser.c
    ├── test_eval.c
    └── test_variables.c
```

## 开发路线图

- [x] **阶段一**：词法分析器 ✅
- [x] **阶段二**：表达式求值器 ✅
- [x] **阶段三**：变量与作用域 ✅
- [ ] **阶段四**：控制流（if/while/for）- 下一步
- [ ] **阶段五**：函数
- [ ] **阶段六**：闭包
- [ ] **阶段七**：数组
- [ ] **阶段八**：字符串增强
- [ ] **阶段九**：Map（字典）
- [ ] **阶段十**：面向对象（类）
- [ ] **阶段十一**：字节码虚拟机
- [ ] **阶段十二**：垃圾回收
- [ ] **阶段十三+**：标准库和优化


## 参考资料

本项目在开发过程中参考了：
- **Lua** - 轻量高效的设计理念
- **Wren** - 优雅的语法和实现
- **QuickJS** - 完整的 JavaScript 实现

## 贡献指南

1. 代码必须清晰易懂，面向初学者
2. 所有注释使用中文
3. 每次提交前运行测试确保通过
4. 遵循项目的代码规范

## 许可证

待定

## 作者

Xray 开发团队

## 性能指标

- **代码规模**：~5,724 行（57.2% 目标）
- **编译时间**：< 2 秒
- **测试覆盖**：123 个测试，100% 通过
- **可执行文件**：~60KB

---

**最后更新**：2025-10-12  
**当前版本**：v0.3.0

